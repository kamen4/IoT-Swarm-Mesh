@using Blazor.Extensions
@using Blazor.Extensions.Canvas
@using Blazor.Extensions.Canvas.Canvas2D
@using Core
@using Core.Devices
@using Core.Services
@using System.Numerics
@using System.Text
@inject IJSRuntime JSRuntime

<div class="simulation-canvas-container w-100 h-100" @ref="_containerRef">
    <BECanvas Width="@_canvasWidth" Height="@_canvasHeight" @ref="_canvasRef"></BECanvas>
</div>

@code {
    private BECanvas? _canvasRef;
    private Canvas2DContext? _context;
    private ElementReference _containerRef;
    private DotNetObjectReference<SimulationCanvas>? _dotNetRef;

    private int _canvasWidth = 800;
    private int _canvasHeight = 600;
    private bool _isInitialized = false;

    [Parameter] public required ISimulationService Sim { get; set; }
    [Parameter] public Device? SendPacketFrom { get; set; }
    [Parameter] public Device? SelectedDevice { get; set; }

    [Parameter] public bool AreVisibilitiesVisible { get; set; } = true;
    [Parameter] public bool AreConnectionsVisible { get; set; } = true;
    [Parameter] public bool ArePacketsVisible { get; set; } = true;
    [Parameter] public bool AreBattariesVisible { get; set; } = true;
    [Parameter] public float PacketSpeed { get; set; } = 200f;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await InitializeCanvas();
            await UpdateCanvasSize();
            _isInitialized = true;

            await JSRuntime.InvokeVoidAsync("simulationCanvas.initResizeListener", _dotNetRef);
        }
    }

    private async Task InitializeCanvas()
    {
        if (_canvasRef is not null)
        {
            _context = await _canvasRef.CreateCanvas2DAsync();
        }
    }

    private async Task UpdateCanvasSize()
    {
        try
        {
            var size = await JSRuntime.InvokeAsync<ContainerSize>("simulationCanvas.getContainerSize", _containerRef);
            _canvasWidth = (int)size.Width;
            _canvasHeight = (int)size.Height;

            if (_isInitialized)
            {
                StateHasChanged();
                await Draw();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error getting container size: {ex.Message}");
            _canvasWidth = 2000;
            _canvasHeight = 1500;
        }
    }

    [JSInvokable]
    public async Task OnWindowResized()
    {
        await UpdateCanvasSize();
    }

    public async Task Draw()
    {
        if (_context is null) return;
        
        await _context.ClearRectAsync(0, 0, _canvasWidth, _canvasHeight);

        if (AreVisibilitiesVisible)
        {
            await DrawVisibilities();
        }
        
        if (AreConnectionsVisible)
        {
            await DrawConnections();
        }
        
        await DrawDevices();
        
        if (ArePacketsVisible)
        {
            await DrawPackets();
        }
    }

    private async Task DrawVisibilities()
    {
        if (_context is null) return;
        
        await _context.SetLineWidthAsync(1.5f);
        await _context.SetStrokeStyleAsync("rgba(255, 180, 180, 0.4)");
        await _context.BeginPathAsync();

        foreach (var (d1, d2) in Sim.Devices.GetAllVisibilities())
        {
            await _context.MoveToAsync(d1.Pos.X, d1.Pos.Y);
            await _context.LineToAsync(d2.Pos.X, d2.Pos.Y);
        }

        await _context.StrokeAsync();
        await _context.ClosePathAsync();
    }

    private async Task DrawConnections()
    {
        if (_context is null) return;

        await _context.SetLineWidthAsync(2.5f);
        await _context.SetStrokeStyleAsync("#4a90d9");
        await _context.BeginPathAsync();

        var drawn = new HashSet<(Guid, Guid)>();
        foreach (var device in Sim.Devices.All)
        {
            foreach (var connected in device.Connections)
            {
                var key = device.Id.CompareTo(connected.Id) < 0 
                    ? (device.Id, connected.Id) 
                    : (connected.Id, device.Id);
                    
                if (drawn.Add(key))
                {
                    await _context.MoveToAsync(device.Pos.X, device.Pos.Y);
                    await _context.LineToAsync(connected.Pos.X, connected.Pos.Y);
                }
            }
        }

        await _context.StrokeAsync();
        await _context.ClosePathAsync();
    }

    private async Task DrawDevices()
    {
        if (_context is null) return;

        foreach (var device in Sim.Devices.All)
        {
            await DrawDevice(device);
        }
    }

    private async Task DrawDevice(Device device)
    {
        if (_context is null) return;
        
        await _context.BeginPathAsync();
        await _context.ArcAsync(device.Pos.X, device.Pos.Y, device.SizeR, 0, 2 * Math.PI);
        await _context.SetFillStyleAsync(device.Color);
        await _context.FillAsync();

        if (device.Equals(SelectedDevice))
        {
            await _context.SetLineWidthAsync(2f);
            await _context.SetStrokeStyleAsync("blue");
            await _context.StrokeAsync();

            await _context.BeginPathAsync();
            await _context.ArcAsync(device.Pos.X, device.Pos.Y, device.Radius, 0, 2 * Math.PI);
            await _context.SetStrokeStyleAsync("orange");
            await _context.SetLineWidthAsync(1f);
            await _context.StrokeAsync();
        }

        if (AreBattariesVisible)
        {
            await DrawBattery(device);
        }

        await DrawDeviceLabel(device);
    }

    private async Task DrawBattery(Device device)
    {
        if (_context is null) return;
        
        const int BATTERY_BAR_W = 20;
        const int BATTERY_BAR_Wh = 10;
        const int BATTERY_BAR_H = 4;

        await _context.BeginPathAsync();
        await _context.SetLineWidthAsync(1f);
        await _context.SetStrokeStyleAsync("black");
        
        if (device.DevicePowerType == Device.PowerType.AC)
        {
            await _context.SetFillStyleAsync("yellow");
            await _context.FillRectAsync(device.Pos.X - BATTERY_BAR_Wh, device.Pos.Y - device.SizeR - BATTERY_BAR_H - 2, BATTERY_BAR_W, BATTERY_BAR_H);
        }
        else
        {
            var batteryColor = device.Battery > 0.5 ? "green" : device.Battery > 0.2 ? "orange" : "red";
            await _context.SetFillStyleAsync(batteryColor);
            await _context.FillRectAsync(device.Pos.X - BATTERY_BAR_Wh, device.Pos.Y - device.SizeR - BATTERY_BAR_H - 2, BATTERY_BAR_W * device.Battery, BATTERY_BAR_H);
        }
        
        await _context.StrokeRectAsync(device.Pos.X - BATTERY_BAR_Wh, device.Pos.Y - device.SizeR - BATTERY_BAR_H - 2, BATTERY_BAR_W, BATTERY_BAR_H);
    }

    private async Task DrawDeviceLabel(Device device)
    {
        if (_context is null) return;
        
        await _context.SetFillStyleAsync("black");
        await _context.SetFontAsync("12px Arial");
        var nameSize = await _context.MeasureTextAsync(device.Name);
        await _context.FillTextAsync(device.Name, device.Pos.X - nameSize.Width / 2, device.Pos.Y + device.SizeR + 15);
    }

    private async Task DrawPackets()
    {
        if (_context is null) return;

        var packets = Sim.Packets.ActivePackets;
        if (packets.Count == 0) return;

        const int PACKET_SIZE = 6;

        foreach (var packet in packets)
        {
            if (packet.CurrentHop is null || packet.NextHop is null) continue;
            
            float distance = Vector2.Distance(packet.CurrentHop.Pos, packet.NextHop.Pos);
            if (distance < 1e-6f) continue;
            
            float timeElapsed = (float)(DateTime.UtcNow - packet.CreatedOn).TotalSeconds;
            float t = MathF.Min(timeElapsed * PacketSpeed / distance, 1f);
            
            var pos = Vector2.Lerp(packet.CurrentHop.Pos, packet.NextHop.Pos, t);
            
            // Разные цвета для разных типов пакетов
            var color = packet.PacketType switch
            {
                PacketType.Ping => "#3366ff",
                PacketType.LampCommand => "#ff9900",
                PacketType.SensorData => "#00cc66",
                PacketType.NetworkBuild => "#cc00cc",
                _ => "#666666"
            };
            
            await _context.SetFillStyleAsync(color);
            await _context.BeginPathAsync();
            await _context.ArcAsync(pos.X, pos.Y, PACKET_SIZE / 2, 0, 2 * Math.PI);
            await _context.FillAsync();
        }
    }

    public async Task Redraw()
    {
        await Draw();
    }

    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }

    public class ContainerSize
    {
        public double Width { get; set; }
        public double Height { get; set; }
    }
}