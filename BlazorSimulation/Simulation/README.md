# IoT Swarm Simulator (Blazor WASM)

Визуальный симулятор «роевой» IoT/mesh-сети: создание устройств, построение связей, запуск симуляции обмена пакетами, сбор статистики, сохранение результатов нескольких прогонов и генерация отчётов.

> Проект состоит из:
> - `Core` — доменная модель, симуляция, маршрутизация, статистика, сериализация.
> - `BlazorApp` — UI (Blazor WebAssembly) и визуализация (canvas).
> - `Tests` — unit-тесты (xUnit).

---

## Возможности

### Устройства
- Типы устройств: `Hub`, `Lamp`, `Sensor`.
- Перетаскивание устройств мышью (изменение позиции).
- Настройки устройства (зависят от формы/модели): имя, радиус, питание/батарея и т.п.

### Видимость и связи
- **Видимость** — геометрическое условие «можно ли установить связь» (по радиусам/дистанции).
- **Связь (connection)** — фактическое ребро графа сети. Пакеты пересылаются только по связям.

### Построение сети
Доступны стратегии построения сети (см. `Core/Services/Strategies`):
- `Sprout` — «проращивание» волнами (от хаба). Устройства обнаруживаются постепенно.
- `Мгновенное` — быстрое построение связей по всем видимым парам.

### Маршрутизация (packet handlers)
Доступны обработчики пакетов (см. `Core/Services/Handlers`), которые определяют куда пересылать пакет дальше:
- `Широковещательный` (`BroadcastHandler`) — flooding по связям.
- `По связям` (`ConnectionBasedHandler`) — обход по графу (с учётом visited).
- `Прямой` (`DirectHandler`) — пытается отправить напрямую по connection, иначе выбирает соседа.
- `Жадный` (`GreedyHandler`) — выбирает ближайшего к цели соседа среди connections.
- `Случайный` (`RandomHandler`) — случайный сосед среди connections.

### Пакеты
- Визуализация движения пакетов на canvas.
- Потери пакетов:
  - Вероятностные (на основе `BasePacketLossRate` и `DistancePacketLossRate`).
  - Потери из-за отсутствия связи на выбранном hop (считается как loss).

### Статистика и отчёты
- Сбор метрик доставки/потерь/дропов/хопов, дистанции, времени доставки.
- Пер-устройство статистика (sent/received/forwarded/battery drain).
- Экспорт:
  - состояние сети (`.json`) — экспорт/импорт через файлы
  - статистика (`.csv`)
  - HTML отчёт с графиками (`.html`) для одного прогона
  - сравнение нескольких прогонов: сохранение результатов и скачивание сравнительного HTML отчёта

---

## Быстрый старт

### Требования
- .NET SDK 9

### Запуск UI (Blazor WASM)
Из папки решения/репозитория:

```bash
dotnet run --project BlazorApp
```

Откройте URL, который выведет CLI.

### Запуск тестов

```bash
dotnet test
```

---

## Как пользоваться симулятором

1. **Создайте устройства** через левую панель (или загрузите пресет, если доступен).
2. **Постройте сеть**:
   - выберите стратегию (`Sprout` / `Мгновенное`) и нажмите «Построить сеть».
3. **Выберите протокол маршрутизации** (обработчик пакетов).
4. **Запустите симуляцию** (генерация трафика) или отправляйте пакет вручную.
5. **Смотрите статистику** справа.
6. (Опционально) **Сохраните результат** прогона и сделайте несколько запусков с разными параметрами.
7. **Скачайте отчёт**:
   - одиночный HTML отчёт
   - сравнительный HTML отчёт по всем сохранённым прогонам
   - CSV по текущей или всем сохранённым

---

## Архитектура (коротко)

### `Core`
Ключевые элементы:
- `Device`, `Hub`, `Lamp`, `Sensor` — модель устройств.
- `Packet` — пакет с `Sender`, `Receiver`, `CurrentHop`, `NextHop`, `TTL`, `HopCount`.
  - Важное: у обычных пакетов первый шаг маршрутизации выбирает обработчик (`IsInitial = true`).
- `PacketService` — симулирует движение пакетов, потери и доставку в обработчики.
- `NetworkBuilderService` + стратегии — создают connections.
- `StatisticsService` — собирает метрики, умеет сохранять несколько результатов.
- `ReportGenerator` — делает HTML отчёты.

### `BlazorApp`
- `Pages/Simulation.razor` — основной UI.
- `Components/SimulationCanvas.razor` — отрисовка устройств/связей/пакетов.
- `wwwroot/js/simulationCanvas.js` — resize и file download/upload helpers.

---

## Как создать и протестировать свой протокол (маршрутизацию)

В проекте есть два «уровня»:

1) **Packet handlers** (`Core/Services/Handlers`) — то, что выбирается в UI как «Протокол маршрутизации».

2) **Protocol routing** (`Core/Protocol/Routing`) — более «протокольный» слой (сообщения/маршрутизация). Он используется в тестах/прототипировании.

Если цель — добавить новый алгоритм маршрутизации в текущий UI, проще всего добавить **новый handler**.

### Вариант A (рекомендуемый для UI): добавить новый `IPacketHandler`

#### 1. Создайте новый класс обработчика
Создайте файл, например `Core/Services/Handlers/MyProtocolHandler.cs` и реализуйте `IPacketHandler`:

- `Name` — отображаемое имя в UI.
- `Handle(Device device, Packet packet, ...)` — логика.

Правила/ожидания:
- Пакеты должны пересылаться **только по `device.Connections`**.
- Если пакет дошёл до получателя (`packet.Receiver?.Id == device.Id`) — вызвать:
  - `device.AcceptPacket(packet)`
  - `statistics.RecordPacketDelivered(packet, deliveryTime)`
- Если `packet.TTL <= 0` — `statistics.RecordPacketDropped(packet, "TTL expired")`.


- Для пересылки создавайте новый hop через `packet.RemakeForNextHop(nextDevice)` и регистрируйте его через `packetService.RegisterPacket(newPacket)`.
- Для предотвращения циклов используйте `packet.HandlerData` (например, HashSet visited / маршрут / таблица).
