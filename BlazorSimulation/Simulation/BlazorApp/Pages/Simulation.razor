@page "/"
@using Blazor.Extensions
@using Blazor.Extensions.Canvas
@using Blazor.Extensions.Canvas.Canvas2D
@using BlazorApp.Components
@using BlazorApp.Models
@using Core.Devices
@using Core.Services
@using Core.Statistics
@using Microsoft.AspNetCore.Components.Web
@using Core
@using System.Numerics
@using System.Text
@using System.Text.Json
@inject ISimulationService Sim
@inject IJSRuntime JS

<PageTitle>IoT Swarm Simulator</PageTitle>

<input type="file" id="importFileInput" accept=".json" style="display:none" @onchange="OnFileSelected" />

<div class="d-flex flex-column vh-100">
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
		<div class="container-fluid">
			<a class="navbar-brand" href="#">IoT Swarm Simulator</a>
			<span class="navbar-text text-light">
				@_stateText | Пакетов: @Sim.Packets.ActivePackets.Count | Связей: @CountConnections()
				@if (Sim.Statistics.SavedResults.Count > 0)
				{
					<span class="badge bg-info ms-2">@Sim.Statistics.SavedResults.Count сохр.</span>
				}
			</span>
		</div>
	</nav>

	<div class="d-flex flex-grow-1 overflow-hidden">
		<div class="bg-light border-end p-3 overflow-auto" style="width:300px;">
			<h5>Управление</h5>
			<div class="d-grid gap-2 w-100">
				<button class="btn btn-primary btn-sm" @onclick="ShowDeviceModalForm">Создать устройство</button>
				
				@if (_selectedDevice is not null)
				{
					<button class="btn btn-primary btn-sm" @onclick="SendPacketButton">Отправить ping</button>
				}

				<hr />
				<h6>Сеть</h6>
				<label class="form-label">
					Стратегия построения
					<select class="form-select form-select-sm" @bind="_selectedBuilderName">
						@foreach (var name in Sim.NetworkBuilder.GetStrategyNames())
						{
							<option value="@name">@name</option>
						}
					</select>
				</label>
				<button class="btn btn-success btn-sm" @onclick="BuildNetwork" 
					disabled="@(Sim.State == SimulationState.BuildingNetwork)">
					Построить сеть
				</button>
				<button class="btn btn-outline-secondary btn-sm" @onclick="ClearConnections">
					Очистить связи
				</button>

				<hr />
				<h6>Симуляция</h6>
				<label class="form-label">
					Протокол маршрутизации
					<select class="form-select form-select-sm" @bind="_selectedHandlerName" @bind:after="HandlerChanged">
						@foreach (var name in Sim.Packets.GetHandlerNames())
						{
							<option value="@name">@name</option>
						}
					</select>
				</label>
				<label class="form-label">
					Интервал пакетов (мс)
					<input type="number" class="form-control form-control-sm" @bind="_config.PacketIntervalMs" min="50" />
				</label>
				<label class="form-label">
					Длительность (мс)
					<input type="number" class="form-control form-control-sm" @bind="_config.SimulationDurationMs" min="1000" />
				</label>
				<label class="form-label">
					Скорость пакетов
					<input type="number" class="form-control form-control-sm" @bind="_config.PacketSpeed" min="50" step="50" />
				</label>
				<label class="form-label">
					Базовый packet loss (0-1)
					<input type="number" class="form-control form-control-sm" @bind="_config.BasePacketLossRate" min="0" max="1" step="0.01" />
				</label>
				<div class="form-check">
					<input class="form-check-input" type="checkbox" @bind="_config.RandomLampCommands" id="lampCmd">
					<label class="form-check-label" for="lampCmd">Команды лампам</label>
				</div>
				<div class="form-check">
					<input class="form-check-input" type="checkbox" @bind="_config.RandomSensorData" id="sensorData">
					<label class="form-check-label" for="sensorData">Данные сенсоров</label>
				</div>
				<button class="btn btn-success btn-sm" @onclick="StartSimulation"
					disabled="@(Sim.State == SimulationState.Running)">
					▶ Запустить
				</button>
				<button class="btn btn-danger btn-sm" @onclick="StopSimulation">
					⏹ Остановить
				</button>
				
				<hr />
				<h6>💾 Сохранение результатов</h6>
				<div class="input-group input-group-sm mb-2">
					<input type="text" class="form-control" placeholder="Имя симуляции" @bind="_saveResultName" />
					<button class="btn btn-outline-primary" @onclick="SaveCurrentResult" 
						disabled="@(_stats.TotalPacketsCreated == 0)">
						Сохранить
					</button>
				</div>
				@if (Sim.Statistics.SavedResults.Count > 0)
				{
					<div class="small text-muted mb-2">
						Сохранено: @Sim.Statistics.SavedResults.Count симуляций
					</div>
					<button class="btn btn-info btn-sm" @onclick="DownloadComparisonReport">
						📊 Скачать сравнительный отчёт
					</button>
					<button class="btn btn-outline-warning btn-sm" @onclick="ClearSavedResults">
						🗑️ Очистить сохранённые
					</button>
				}

				<hr />
				<h6>Отображение</h6>
				<div class="form-check">
					<input class="form-check-input" type="checkbox" @bind="_areVisibilitiesVisible" id="visCheck">
					<label class="form-check-label" for="visCheck">Видимости</label>
				</div>
				<div class="form-check">
					<input class="form-check-input" type="checkbox" @bind="_areConnectionsVisible" id="connCheck">
					<label class="form-check-label" for="connCheck">Связи</label>
				</div>
				<div class="form-check">
					<input class="form-check-input" type="checkbox" @bind="_arePacketsVisible" id="packCheck">
					<label class="form-check-label" for="packCheck">Пакеты</label>
				</div>
				<div class="form-check">
					<input class="form-check-input" type="checkbox" @bind="_areBattariesVisible" id="battCheck">
					<label class="form-check-label" for="battCheck">Заряд</label>
				</div>

				<hr />
				<h6>Пресеты</h6>
				<select class="form-select form-select-sm mb-2" @bind="_selectedPreset">
					@foreach (var name in Sim.Devices.GetPresetNames())
					{
						<option value="@name">@name</option>
					}
				</select>
				<button class="btn btn-outline-primary btn-sm" @onclick="LoadPreset">Загрузить пресет</button>

				<hr />
				<h6>Экспорт/Импорт</h6>
				<button class="btn btn-outline-info btn-sm" @onclick="DownloadState">
					📥 Скачать состояние
				</button>
				<button class="btn btn-outline-info btn-sm" @onclick="TriggerImportFile">
					📤 Загрузить состояние
				</button>
				<button class="btn btn-outline-success btn-sm" @onclick="DownloadStatisticsCsv">
					📊 Скачать статистику
				</button>
				<button class="btn btn-success btn-sm" @onclick="DownloadReport">
					📈 Скачать отчёт
				</button>
			</div>
		</div>

		<div class="flex-grow-1 position-relative bg-white"
			@onmousedown="OnMouseDown"
			@onmousemove="OnMouseMove"
			@onmouseup="OnMouseUp"
			@oncontextmenu:preventDefault
			@oncontextmenu="OnRightClick">
			<SimulationCanvas @ref="_canvasRef"
				Sim="Sim"
				SendPacketFrom="_sendPacketFrom"
				SelectedDevice="_selectedDevice"
				AreConnectionsVisible="_areConnectionsVisible"
				AreVisibilitiesVisible="_areVisibilitiesVisible"
				ArePacketsVisible="_arePacketsVisible"
				AreBattariesVisible="_areBattariesVisible"
				PacketSpeed="_config.PacketSpeed" />
		</div>

		<div class="bg-light border-start p-3" style="width:280px; overflow-y:auto;">
			<h6>Текущая статистика</h6>
			<table class="table table-sm table-borderless">
				<tr><td>Создано</td><td><strong>@_stats.TotalPacketsCreated</strong></td></tr>
				<tr><td>Доставлено</td><td><strong class="text-success">@_stats.TotalPacketsDelivered</strong></td></tr>
				<tr><td>Потеряно</td><td><strong class="text-danger">@_stats.TotalPacketsLost</strong></td></tr>
				<tr><td>Dropped</td><td><strong class="text-warning">@_stats.TotalPacketsDropped</strong></td></tr>
				<tr><td>Forwarded</td><td><strong>@_stats.TotalPacketsForwarded</strong></td></tr>
				<tr><td>Хопов</td><td><strong>@_stats.TotalHops</strong></td></tr>
				<tr><td colspan="2"><hr class="my-1"/></td></tr>
				<tr><td>Доставляемость</td><td><strong class="@GetDeliveryRateClass()">@_stats.DeliveryRate.ToString("F1")%</strong></td></tr>
				<tr><td>Loss rate</td><td><strong class="@GetLossRateClass()">@_stats.LossRate.ToString("F1")%</strong></td></tr>
				<tr><td>Avg hops</td><td><strong>@_stats.AverageHopsPerPacket.ToString("F1")</strong></td></tr>
				<tr><td colspan="2"><hr class="my-1"/></td></tr>
				<tr><td>Avg time</td><td><strong>@_stats.AverageDeliveryTimeMs.ToString("F0") ms</strong></td></tr>
				<tr><td>Min time</td><td><strong>@((_stats.MinDeliveryTimeMs == double.MaxValue ? 0 : _stats.MinDeliveryTimeMs).ToString("F0")) ms</strong></td></tr>
				<tr><td>Max time</td><td><strong>@_stats.MaxDeliveryTimeMs.ToString("F0") ms</strong></td></tr>
			</table>
			
			@if (Sim.Statistics.SavedResults.Count > 0)
			{
				<h6 class="mt-3">💾 Сохранённые симуляции</h6>
				<div style="max-height: 200px; overflow-y: auto;">
					@foreach (var (result, idx) in Sim.Statistics.SavedResults.Select((r,i) => (r,i)))
					{
						<div class="card card-body p-2 mb-1 small">
							<div class="d-flex justify-content-between align-items-start">
								<div>
									<strong>@result.Name</strong><br/>
									<span class="text-muted">@result.Config.ProtocolName</span><br/>
									<span class="text-success">@result.Statistics.DeliveryRate.ToString("F0")%</span> доставлено
								</div>
								<button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveSavedResult(idx)">×</button>
							</div>
						</div>
					}
				</div>
			}
			
			@if (_stats.DeviceStats.Count > 0)
			{
				<h6 class="mt-3">По устройствам</h6>
				<div style="max-height: 150px; overflow-y: auto;">
					<table class="table table-sm">
						<thead><tr><th>Устр.</th><th>Отпр.</th><th>Получ.</th></tr></thead>
						<tbody>
						@foreach (var (id, ds) in _stats.DeviceStats.Take(10))
						{
							<tr>
								<td>@ds.DeviceName</td>
								<td>@ds.PacketsSent</td>
								<td>@ds.PacketsReceived</td>
							</tr>
						}
						</tbody>
					</table>
				</div>
			}
		</div>

		@if (_sendPacketFrom is not null)
		{
			<p class="position-absolute text-secondary" style="bottom:1.5vh; width: 100vw; text-align: center;">
				Выберите устройство для отправки ping
			</p>
		}
	</div>
</div>

@if (_isDeviceModalFormVisible && _formDeviceModel is not null)
{
	<DeviceFormModal Device="_formDeviceModel"
		IsEditMode="_isDeviceContextMenuVisible"
		OnClose="CloseDeviceModalForm"
		OnValidSubmit="SubmitDeviceForm" />
}

@if (_isDeviceContextMenuVisible && _selectedDevice is not null)
{
	<div class="position-absolute bg-white border rounded shadow p-2"
		style="z-index:1000; width:150px; top:@(_contextMenuPositionPX.Y); left:@(_contextMenuPositionPX.X);">
		<button class="btn btn-sm btn-secondary w-100 mb-1" @onclick="EditSelectedDevice">Изменить</button>
		<button class="btn btn-sm btn-danger w-100 mb-1" @onclick="DeleteSelectedDevice">Удалить</button>
		@if (_selectedDevice is not Hub)
		{
			<button class="btn btn-sm btn-info w-100" @onclick="CloneSelectedDevice">Клонировать</button>
		}
	</div>
}

@code {
	private SimulationCanvas _canvasRef = null!;

	private bool _isDeviceModalFormVisible = false;
	private Device? _formDevice;
	private DeviceModel? _formDeviceModel;

	private Device? _selectedDevice = null;
	private bool _deviceDragFlag = false;

	private bool _isDeviceContextMenuVisible = false;
	private (double X, double Y) _contextMenuPosition;
	private (string X, string Y) _contextMenuPositionPX => ($"{_contextMenuPosition.X}px", $"{_contextMenuPosition.Y}px");

	private Device? _sendPacketFrom = null;

	private PeriodicTimer? _timer;
	private bool _animating = false;

	private string _selectedHandlerName = "";
	private string _selectedBuilderName = "";
	private string _selectedPreset = "Line";
	private string _saveResultName = "";

	private bool _areVisibilitiesVisible = true;
	private bool _areConnectionsVisible = true;
	private bool _arePacketsVisible = true;
	private bool _areBattariesVisible = true;

	private SimulationConfig _config = new() { PacketSpeed = 200f };
	private SimulationStatistics _stats => Sim.Statistics.Current;
	
	private string _stateText => Sim.State switch
	{
		SimulationState.Idle => "Готов",
		SimulationState.BuildingNetwork => "Построение сети...",
		SimulationState.Running => "Симуляция...",
		SimulationState.Paused => "Пауза",
		SimulationState.Completed => "Завершено",
		_ => ""
	};

	private string GetDeliveryRateClass() => _stats.DeliveryRate > 80 ? "text-success" : _stats.DeliveryRate > 50 ? "text-warning" : "text-danger";
	private string GetLossRateClass() => _stats.LossRate < 10 ? "text-success" : _stats.LossRate < 30 ? "text-warning" : "text-danger";
	
	private int CountConnections()
	{
		int count = 0;
		var seen = new HashSet<(Guid, Guid)>();
		foreach (var d in Sim.Devices.All)
		{
			foreach (var c in d.Connections)
			{
				var key = d.Id.CompareTo(c.Id) < 0 ? (d.Id, c.Id) : (c.Id, d.Id);
				if (seen.Add(key)) count++;
			}
		}
		return count;
	}

	protected override void OnInitialized()
	{
		_selectedHandlerName = Sim.Packets.GetHandlerNames().FirstOrDefault() ?? "";
		_selectedBuilderName = Sim.NetworkBuilder.GetStrategyNames().FirstOrDefault() ?? "";
		Sim.OnStateChanged += _ => InvokeAsync(StateHasChanged);
	}

	protected override void OnAfterRender(bool firstRender)
	{
		if (firstRender)
		{
			StartAnimationLoop();
		}
	}

	private void StartAnimationLoop()
	{
		if (_animating) return;
		_animating = true;
		_timer = new PeriodicTimer(TimeSpan.FromMilliseconds(16));
		_ = AnimateLoop();
	}

	private async Task AnimateLoop()
	{
		while (_animating && await _timer!.WaitForNextTickAsync())
		{
			Sim.Tick();
			if (_canvasRef is not null)
			{
				await _canvasRef.Redraw();
			}
			StateHasChanged();
		}
	}

	private void ShowDeviceModalForm()
	{
		_formDeviceModel = new DeviceModel();
		_isDeviceModalFormVisible = true;
	}

	private void CloseDeviceModalForm()
	{
		_isDeviceModalFormVisible = false;
		_isDeviceContextMenuVisible = false;
	}

	private async Task SubmitDeviceForm()
	{
		_isDeviceModalFormVisible = false;
		if (_formDeviceModel is null) return;

		if (_isDeviceContextMenuVisible)
		{
			_isDeviceContextMenuVisible = false;
			_formDeviceModel.ApplyTo(_formDevice);
			_formDevice = null;
		}
		else
		{
			_formDevice = _formDeviceModel.ToDevice();
			Sim.Devices.Add(_formDevice);
		}

		await _canvasRef.Redraw();
		StateHasChanged();
	}

	private async void OnMouseDown(MouseEventArgs e)
	{
		if (e.Button == 2) return;
		_isDeviceContextMenuVisible = false;

		if (_formDevice is not null)
		{
			_selectedDevice = _formDevice;
			_formDevice = null;
			await _canvasRef.Redraw();
			return;
		}

		_selectedDevice = Sim.Devices.GetAtPosition(new((float)e.OffsetX, (float)e.OffsetY));
		_deviceDragFlag = _selectedDevice is not null;

		if (_sendPacketFrom is not null)
		{
			if (_selectedDevice is not null)
			{
				SendPacket(_sendPacketFrom, _selectedDevice);
			}
			_sendPacketFrom = null;
			_selectedDevice = null;
		}

		await _canvasRef.Redraw();
	}

	private void OnMouseMove(MouseEventArgs e)
	{
		if (_formDevice is not null)
		{
			_formDevice.Pos = new((float)e.OffsetX, (float)e.OffsetY);
		}

		if (_deviceDragFlag && _selectedDevice is not null)
		{
			_selectedDevice.Pos = new((float)e.OffsetX, (float)e.OffsetY);
		}
	}

	private void OnMouseUp(MouseEventArgs e)
	{
		_deviceDragFlag = false;
	}

	private async void OnRightClick(MouseEventArgs e)
	{
		_selectedDevice = Sim.Devices.GetAtPosition(new((float)e.OffsetX, (float)e.OffsetY));

		if (_selectedDevice is not null)
		{
			_contextMenuPosition = (e.PageX, e.PageY);
			_isDeviceContextMenuVisible = true;
		}
		else
		{
			_isDeviceContextMenuVisible = false;
		}

		await _canvasRef.Redraw();
	}

	private void EditSelectedDevice()
	{
		if (_selectedDevice is null) return;
		_formDevice = _selectedDevice;
		_formDeviceModel = new DeviceModel(_formDevice);
		_isDeviceModalFormVisible = true;
	}

	private async void DeleteSelectedDevice()
	{
		if (_selectedDevice is null) return;
		_isDeviceContextMenuVisible = false;
		Sim.Devices.Remove(_selectedDevice);
		_selectedDevice = null;
		await _canvasRef.Redraw();
	}

	private async void CloneSelectedDevice()
	{
		if (_selectedDevice is null) return;
		_isDeviceContextMenuVisible = false;
		_formDevice = (Device)_selectedDevice.Clone();
		Sim.Devices.Add(_formDevice);
		await _canvasRef.Redraw();
	}

	private void SendPacketButton()
	{
		_sendPacketFrom = _selectedDevice;
		_selectedDevice = null;
	}

	private void SendPacket(Device from, Device to)
	{
		var packet = Sim.Packets.CreatePing(from, to);
		Sim.Statistics.RecordPacketCreated(packet);
	}

	private void HandlerChanged()
	{
		if (!string.IsNullOrEmpty(_selectedHandlerName))
		{
			Sim.Packets.SetActiveHandler(_selectedHandlerName);
		}
	}

	private async Task BuildNetwork()
	{
		if (!string.IsNullOrEmpty(_selectedBuilderName))
		{
			Sim.NetworkBuilder.SetActiveStrategy(_selectedBuilderName);
		}
		await Sim.StartNetworkBuildAsync();
	}

	private async Task ClearConnections()
	{
		Sim.NetworkBuilder.ClearConnections();
		await _canvasRef.Redraw();
	}

	private async Task StartSimulation()
	{
		_config.ProtocolName = _selectedHandlerName;
		_config.NetworkStrategy = _selectedBuilderName;
		Sim.Packets.SetConfig(_config);
		Sim.Statistics.Reset();
		await Sim.StartDataSimulationAsync(_config);
	}

	private void StopSimulation()
	{
		Sim.StopSimulation();
	}

	private void SaveCurrentResult()
	{
		var name = string.IsNullOrWhiteSpace(_saveResultName) 
			? $"Симуляция {Sim.Statistics.SavedResults.Count + 1}" 
			: _saveResultName;
		Sim.Statistics.SaveCurrentResult(name, _config.Clone());
		_saveResultName = "";
		StateHasChanged();
	}

	private void RemoveSavedResult(int index)
	{
		Sim.Statistics.RemoveSavedResult(index);
		StateHasChanged();
	}

	private void ClearSavedResults()
	{
		Sim.Statistics.ClearSavedResults();
		StateHasChanged();
	}

	private async Task LoadPreset()
	{
		Sim.Devices.LoadPreset(_selectedPreset);
		await _canvasRef.Redraw();
	}

	// File operations
	private async Task DownloadState()
	{
		var json = Sim.Serialization.SerializeDevices(Sim.Devices.All);
		var filename = $"simulation_state_{DateTime.Now:yyyyMMdd_HHmmss}.json";
		await JS.InvokeVoidAsync("fileUtils.downloadFile", filename, json, "application/json");
	}

	private async Task TriggerImportFile()
	{
		await JS.InvokeVoidAsync("fileUtils.triggerFileInput", "importFileInput");
	}

	private async Task OnFileSelected(ChangeEventArgs e)
	{
		try
		{
			var content = await JS.InvokeAsync<string>("fileUtils.uploadFile", "importFileInput");
			var devices = Sim.Serialization.DeserializeDevices(content);
			Sim.Devices.Clear();
			foreach (var d in devices)
			{
				Sim.Devices.Add(d);
			}
			await _canvasRef.Redraw();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Import error: {ex.Message}");
		}
	}

	private async Task DownloadStatisticsCsv()
	{
		string csv;
		if (Sim.Statistics.SavedResults.Count > 0)
		{
			csv = Sim.Statistics.ExportAllResultsToCsv();
		}
		else
		{
			csv = Sim.Statistics.ExportToCsv() + "\n\n" + Sim.Statistics.ExportPacketLogToCsv();
		}
		var filename = $"simulation_stats_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
		await JS.InvokeVoidAsync("fileUtils.downloadFile", filename, csv, "text/csv");
	}

	private async Task DownloadReport()
	{
		var html = ReportGenerator.GenerateHtmlReport(_stats);
		var filename = $"simulation_report_{DateTime.Now:yyyyMMdd_HHmmss}.html";
		await JS.InvokeVoidAsync("fileUtils.downloadFile", filename, html, "text/html");
	}

	private async Task DownloadComparisonReport()
	{
		var html = ReportGenerator.GenerateComparisonReport(Sim.Statistics.SavedResults);
		var filename = $"comparison_report_{DateTime.Now:yyyyMMdd_HHmmss}.html";
		await JS.InvokeVoidAsync("fileUtils.downloadFile", filename, html, "text/html");
	}
}