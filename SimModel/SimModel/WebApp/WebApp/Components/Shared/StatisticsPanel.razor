@using Engine.Statistics
@implements IDisposable

@* Real-time statistics drawer.
   Driven entirely by SimulationStatistics.Metrics — add a new StatMetric
   there to have it appear here automatically. *@

<div class="stats-drawer @(_visible ? "stats-drawer--open" : "")">

    <div class="stats-drawer-header">
        <span>?? Statistics</span>
        <div class="stats-drawer-actions">
            <button class="btn btn-ghost btn-sm" @onclick="() => _showDetail = true">? Detailed</button>
            <button class="btn btn-ghost btn-sm" @onclick="OnReset">? Reset</button>
            <button class="btn btn-ghost btn-sm" @onclick="Close">?</button>
        </div>
    </div>

    <div class="stats-grid">
        @foreach (var metric in Stats.Metrics)
        {
            <div class="stat-card" title="@metric.Description">
                <span class="stat-label">@metric.Label</span>
                <span class="stat-value">@metric.DisplayValue</span>
            </div>
        }
    </div>

</div>

@if (_showDetail)
{
    <DetailedStatsModal Stats="Stats"
                        OnClose="() => _showDetail = false"
                        OnResetStats="OnReset" />
}

@code {
    [Parameter, EditorRequired] public SimulationStatistics Stats        { get; set; } = null!;
    [Parameter]                 public bool                 Visible      { get; set; }
    [Parameter]                 public EventCallback        OnClose      { get; set; }
    [Parameter]                 public EventCallback        OnResetStats { get; set; }

    private bool _visible;
    private bool _showDetail;

    protected override void OnParametersSet()  => _visible = Visible;
    protected override void OnInitialized()    => Stats.Updated += OnStatsUpdated;

    private void OnStatsUpdated() => InvokeAsync(StateHasChanged);

    private async Task Close()   => await OnClose.InvokeAsync();
    private async Task OnReset()
    {
        _showDetail = false;
        await OnResetStats.InvokeAsync();
    }

    public void Dispose() => Stats.Updated -= OnStatsUpdated;
}
